#!/bin/bash
# WineLab API Management - wlapi command
# Usage: wlapi [start|stop|restart|rebuild|logs|status|update]

PROJECT_DIR="/home/prsta/winelab_web_admin/winelab_api"
SERVICE_NAME="winelab-api"

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

cd "$PROJECT_DIR" || { echo -e "${RED}âŒ Directory not found: $PROJECT_DIR${NC}"; exit 1; }

# Function to start API properly
start_api() {
    # Build if needed
    if [ ! -f "dist/src/main.js" ]; then
        echo -e "${BLUE}  â†’ Building API...${NC}"
        npm run build
    fi
    
    # Start with node directly (not nest CLI)
    pm2 start dist/src/main.js --name "$SERVICE_NAME" 2>/dev/null || pm2 restart "$SERVICE_NAME"
}

case "$1" in
    start)
        echo -e "${GREEN}â–¶ Starting WineLab API...${NC}"
        docker compose up -d
        start_api
        pm2 save
        echo -e "${GREEN}âœ… API started on http://localhost:3001${NC}"
        ;;
    
    stop)
        echo -e "${YELLOW}â¹ Stopping WineLab API...${NC}"
        pm2 stop "$SERVICE_NAME" 2>/dev/null
        echo -e "${GREEN}âœ… API stopped${NC}"
        ;;
    
    restart)
        echo -e "${BLUE}ðŸ”„ Restarting WineLab API...${NC}"
        pm2 restart "$SERVICE_NAME"
        echo -e "${GREEN}âœ… API restarted${NC}"
        ;;
    
    rebuild)
        echo -e "${YELLOW}ðŸ”¨ Rebuilding WineLab API...${NC}"
        
        # Stop service
        echo -e "${BLUE}  â†’ Stopping service...${NC}"
        pm2 delete "$SERVICE_NAME" 2>/dev/null
        
        # Check if clean rebuild needed
        if [ "$2" == "--clean" ] || [ ! -d "node_modules" ]; then
            echo -e "${BLUE}  â†’ Cleaning old files...${NC}"
            rm -rf node_modules dist package-lock.json
            docker compose down -v
            docker system prune -f --volumes 2>/dev/null
            
            echo -e "${BLUE}  â†’ Installing dependencies...${NC}"
            npm install
            chmod +x node_modules/.bin/* 2>/dev/null || true
        fi
        
        echo -e "${BLUE}  â†’ Starting database...${NC}"
        docker compose up -d
        sleep 3
        
        echo -e "${BLUE}  â†’ Generating Prisma client...${NC}"
        npx prisma generate
        
        # Check if migration needed
        echo -e "${BLUE}  â†’ Checking migrations...${NC}"
        npx prisma migrate deploy
        
        # Build
        echo -e "${BLUE}  â†’ Building API...${NC}"
        npm run build
        
        # Start
        echo -e "${BLUE}  â†’ Starting API...${NC}"
        pm2 start dist/src/main.js --name "$SERVICE_NAME"
        pm2 save
        
        echo -e "${GREEN}âœ… API rebuilt and started on http://localhost:3001${NC}"
        ;;
    
    update)
        echo -e "${BLUE}ðŸ”„ Updating WineLab API...${NC}"
        
        # Load environment variables
        if [ -f ".env" ]; then
            export $(grep -v '^#' .env | xargs)
        fi
        
        # Save package.json hash before pull
        OLD_HASH=$(md5sum package.json 2>/dev/null | cut -d' ' -f1)
        
        echo -e "${BLUE}  â†’ Pulling latest changes...${NC}"
        cd ..
        git fetch origin
        git reset --hard origin/main
        cd winelab_api
        
        # Fix line endings
        sed -i 's/\r$//' ../scripts/* 2>/dev/null || true
        
        # Check if package.json changed or node_modules missing
        NEW_HASH=$(md5sum package.json 2>/dev/null | cut -d' ' -f1)
        if [ "$OLD_HASH" != "$NEW_HASH" ] || [ ! -d "node_modules" ]; then
            echo -e "${YELLOW}  â†’ Dependencies changed or missing, installing...${NC}"
            rm -rf node_modules package-lock.json
            npm install
            chmod +x node_modules/.bin/* 2>/dev/null || true
        fi
        
        echo -e "${BLUE}  â†’ Generating Prisma client...${NC}"
        npx prisma generate
        
        echo -e "${BLUE}  â†’ Applying database migrations...${NC}"
        npx prisma migrate deploy 2>/dev/null || echo -e "${YELLOW}  â†’ No pending migrations${NC}"
        
        # Delete dist and rebuild
        echo -e "${BLUE}  â†’ Rebuilding API...${NC}"
        rm -rf dist
        npm run build
        
        # Restart service - use node directly
        echo -e "${BLUE}  â†’ Restarting API...${NC}"
        pm2 delete "$SERVICE_NAME" 2>/dev/null
        pm2 start dist/src/main.js --name "$SERVICE_NAME"
        pm2 save
        
        echo -e "${GREEN}âœ… API updated successfully${NC}"
        ;;
    
    logs)
        pm2 logs "$SERVICE_NAME" --lines 100
        ;;
    
    status)
        echo -e "${BLUE}ðŸ“Š WineLab API Status${NC}"
        echo ""
        echo -e "${YELLOW}PM2:${NC}"
        pm2 status "$SERVICE_NAME"
        echo ""
        echo -e "${YELLOW}Docker:${NC}"
        docker compose ps
        echo ""
        echo -e "${YELLOW}Build:${NC}"
        if [ -f "dist/src/main.js" ]; then
            echo "  dist/src/main.js: EXISTS"
        else
            echo "  dist/src/main.js: NOT BUILT"
        fi
        ;;
    
    db)
        case "$2" in
            migrate)
                echo -e "${BLUE}ðŸ”„ Running migrations...${NC}"
                npx prisma migrate dev
                ;;
            seed)
                echo -e "${BLUE}ðŸŒ± Seeding database...${NC}"
                npm run db:seed
                ;;
            studio)
                echo -e "${BLUE}ðŸŽ¨ Opening Prisma Studio on port 5555...${NC}"
                npx prisma studio
                ;;
            reset)
                echo -e "${RED}âš  Resetting database...${NC}"
                npx prisma migrate reset --force
                npm run db:seed
                ;;
            *)
                echo "Usage: wlapi db [migrate|seed|studio|reset]"
                ;;
        esac
        ;;
    
    *)
        echo -e "${BLUE}WineLab API Management${NC}"
        echo ""
        echo "Usage: wlapi [command]"
        echo ""
        echo "Commands:"
        echo "  start       Start API and database"
        echo "  stop        Stop API"
        echo "  restart     Restart API"
        echo "  rebuild     Rebuild API (use --clean for full cleanup)"
        echo "  update      Git pull, rebuild, and restart"
        echo "  logs        Show API logs"
        echo "  status      Show service status"
        echo ""
        echo "Database:"
        echo "  db migrate  Run migrations"
        echo "  db seed     Seed test data"
        echo "  db studio   Open Prisma Studio"
        echo "  db reset    Reset and reseed database"
        ;;
esac
