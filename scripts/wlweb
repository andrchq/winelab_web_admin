#!/bin/bash
# WineLab Web Frontend Management - wlweb command
# Usage: wlweb [start|stop|restart|rebuild|logs|status|update]

PROJECT_DIR="/home/prsta/winelab_web_admin"
SERVICE_NAME="wlweb"
API_SERVICE_NAME="winelab-api"
API_DIR="$PROJECT_DIR/winelab_api"

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

cd "$PROJECT_DIR" || { echo -e "${RED}âŒ Directory not found: $PROJECT_DIR${NC}"; exit 1; }

start_api() {
    echo -e "${BLUE}  â†’ Starting API...${NC}"
    cd "$API_DIR"
    
    # Build if dist doesn't exist
    if [ ! -f "dist/src/main.js" ]; then
        echo -e "${YELLOW}  â†’ Building API (first time)...${NC}"
        npm run build
    fi
    
    # Start with node directly (not nest)
    pm2 start dist/src/main.js --name "$API_SERVICE_NAME" 2>/dev/null || pm2 restart "$API_SERVICE_NAME"
    cd "$PROJECT_DIR"
}

case "$1" in
    start)
        echo -e "${GREEN}â–¶ Starting WineLab Web...${NC}"
        pm2 start npm --name "$SERVICE_NAME" -- run start 2>/dev/null || pm2 restart "$SERVICE_NAME"
        echo -e "${GREEN}âœ… Web started on http://localhost:8888${NC}"
        ;;
    
    stop)
        echo -e "${YELLOW}â¹ Stopping WineLab Web...${NC}"
        pm2 stop "$SERVICE_NAME" 2>/dev/null
        echo -e "${GREEN}âœ… Web stopped${NC}"
        ;;
    
    restart)
        echo -e "${BLUE}ðŸ”„ Restarting WineLab Web...${NC}"
        pm2 restart "$SERVICE_NAME"
        echo -e "${GREEN}âœ… Web restarted${NC}"
        ;;
    
    rebuild)
        echo -e "${YELLOW}ðŸ”¨ Rebuilding WineLab Web...${NC}"
        
        # Stop service
        echo -e "${BLUE}  â†’ Stopping web service...${NC}"
        pm2 delete "$SERVICE_NAME" 2>/dev/null
        
        # Check if clean rebuild needed
        if [ "$2" == "--clean" ] || [ ! -d "node_modules" ]; then
            echo -e "${BLUE}  â†’ Cleaning old files...${NC}"
            rm -rf node_modules .next package-lock.json
            
            echo -e "${BLUE}  â†’ Installing dependencies...${NC}"
            npm install --legacy-peer-deps
        else
            # Always clean .next for rebuild
            echo -e "${BLUE}  â†’ Cleaning previous build...${NC}"
            rm -rf .next
        fi
        
        # Build
        echo -e "${BLUE}  â†’ Building production...${NC}"
        npm run build
        
        if [ $? -ne 0 ]; then
            echo -e "${RED}âŒ Build failed! Check errors above.${NC}"
            exit 1
        fi
        
        # Start web
        echo -e "${BLUE}  â†’ Starting web server...${NC}"
        pm2 start npm --name "$SERVICE_NAME" -- run start
        
        # Also restart API
        echo -e "${BLUE}  â†’ Restarting API...${NC}"
        pm2 restart "$API_SERVICE_NAME" 2>/dev/null || start_api
        
        pm2 save
        
        echo -e "${GREEN}âœ… Web rebuilt and started on http://localhost:8888${NC}"
        ;;
    
    update)
        echo -e "${BLUE}ðŸ”„ Updating WineLab Web from GitHub...${NC}"
        
        # Save package.json hashes before pull
        OLD_WEB_HASH=$(md5sum package.json 2>/dev/null | cut -d' ' -f1)
        OLD_API_HASH=$(md5sum winelab_api/package.json 2>/dev/null | cut -d' ' -f1)
        
        echo -e "${BLUE}  â†’ Pulling latest changes...${NC}"
        git fetch origin
        git reset --hard origin/main
        
        # Fix line endings
        find scripts -type f -exec sed -i 's/\r$//' {} \; 2>/dev/null || true
        
        # Check if web package.json changed or node_modules missing
        NEW_WEB_HASH=$(md5sum package.json 2>/dev/null | cut -d' ' -f1)
        if [ "$OLD_WEB_HASH" != "$NEW_WEB_HASH" ] || [ ! -d "node_modules" ]; then
            echo -e "${YELLOW}  â†’ Web dependencies changed or missing, installing...${NC}"
            rm -rf node_modules package-lock.json
            npm install --legacy-peer-deps
        fi
        
        # Check if API package.json changed or node_modules missing
        NEW_API_HASH=$(md5sum winelab_api/package.json 2>/dev/null | cut -d' ' -f1)
        if [ "$OLD_API_HASH" != "$NEW_API_HASH" ] || [ ! -d "winelab_api/node_modules" ]; then
            echo -e "${YELLOW}  â†’ API dependencies changed or missing, installing...${NC}"
            cd winelab_api
            rm -rf node_modules package-lock.json
            npm install
            chmod +x node_modules/.bin/* 2>/dev/null || true
            cd ..
        fi
        
        # Update API (generates Prisma, runs migrations)
        echo -e "${BLUE}  â†’ Updating API...${NC}"
        cd winelab_api
        
        # Export for prisma if file exists
        if [ -f ".env" ]; then
            export $(grep -v '^#' .env | xargs)
        fi
        
        npx prisma generate
        npx prisma migrate deploy 2>/dev/null || echo -e "${YELLOW}  â†’ No pending migrations${NC}"
        
        # Build API
        echo -e "${BLUE}  â†’ Building API...${NC}"
        npm run build
        
        cd ..
        
        # Rebuild web
        echo -e "${BLUE}  â†’ Setting permissions...${NC}"
        chmod +x node_modules/.bin/* 2>/dev/null || true
        
        echo -e "${BLUE}  â†’ Cleaning build cache...${NC}"
        rm -rf .next
        rm -rf node_modules/.cache
        
        echo -e "${BLUE}  â†’ Rebuilding web...${NC}"
        npm run build
        
        if [ $? -ne 0 ]; then
            echo -e "${YELLOW}  â†’ Build failed, trying with clean node_modules...${NC}"
            rm -rf node_modules package-lock.json
            npm install --legacy-peer-deps
            npm run build
        fi
        
        if [ $? -ne 0 ]; then
            echo -e "${RED}âŒ Build failed again! Check errors above.${NC}"
            exit 1
        fi
        
        # Restart/Start services
        echo -e "${BLUE}  â†’ Starting/Restarting services...${NC}"
        
        # Web
        pm2 delete "$SERVICE_NAME" 2>/dev/null
        pm2 start npm --name "$SERVICE_NAME" -- run start
        
        # API - use node directly, not npm
        pm2 delete "$API_SERVICE_NAME" 2>/dev/null
        cd winelab_api
        pm2 start dist/src/main.js --name "$API_SERVICE_NAME"
        cd ..
        
        pm2 save
        
        echo -e "${GREEN}âœ… WineLab updated successfully!${NC}"
        echo -e "${BLUE}   Web: http://YOUR_SERVER_IP:8888${NC}"
        echo -e "${BLUE}   API: http://YOUR_SERVER_IP:3001${NC}"
        pm2 list
        ;;
    
    dev)
        echo -e "${BLUE}ðŸ”§ Starting in development mode...${NC}"
        pm2 stop "$SERVICE_NAME" 2>/dev/null
        npm run dev
        ;;
    
    logs)
        pm2 logs "$SERVICE_NAME" --lines 100
        ;;
    
    status)
        echo -e "${BLUE}ðŸ“Š WineLab Status${NC}"
        echo ""
        pm2 list
        echo ""
        echo -e "${YELLOW}Build info:${NC}"
        if [ -d ".next" ]; then
            echo "  Web (.next): $(du -sh .next | cut -f1)"
        else
            echo "  Web: NOT BUILT"
        fi
        if [ -d "winelab_api/dist" ]; then
            echo "  API (dist): $(du -sh winelab_api/dist | cut -f1)"
        else
            echo "  API: NOT BUILT"
        fi
        ;;
    
    *)
        echo -e "${BLUE}WineLab Web Management${NC}"
        echo ""
        echo "Usage: wlweb [command]"
        echo ""
        echo "Commands:"
        echo "  start       Start web server (production)"
        echo "  stop        Stop web server"
        echo "  restart     Restart web server"
        echo "  rebuild     Rebuild and restart (use --clean for full cleanup)"
        echo "  update      Git pull, rebuild, and restart all"
        echo "  dev         Start in development mode"
        echo "  logs        Show web logs"
        echo "  status      Show service status"
        echo ""
        echo "Note: update also rebuilds and restarts API"
        ;;
esac
