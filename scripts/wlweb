#!/bin/bash
# WineLab Web Frontend Management - wlweb command
# Usage: wlweb [start|stop|restart|rebuild|logs|status|update]

PROJECT_DIR="/home/prsta/winelab_web_admin"
SERVICE_NAME="winelab-web"

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

cd "$PROJECT_DIR" || { echo -e "${RED}âŒ Directory not found: $PROJECT_DIR${NC}"; exit 1; }

case "$1" in
    start)
        echo -e "${GREEN}â–¶ Starting WineLab Web...${NC}"
        pm2 start npm --name "$SERVICE_NAME" -- run start 2>/dev/null || pm2 restart "$SERVICE_NAME"
        echo -e "${GREEN}âœ… Web started on http://localhost:8888${NC}"
        ;;
    
    stop)
        echo -e "${YELLOW}â¹ Stopping WineLab Web...${NC}"
        pm2 stop "$SERVICE_NAME" 2>/dev/null
        echo -e "${GREEN}âœ… Web stopped${NC}"
        ;;
    
    restart)
        echo -e "${BLUE}ðŸ”„ Restarting WineLab Web...${NC}"
        pm2 restart "$SERVICE_NAME"
        echo -e "${GREEN}âœ… Web restarted${NC}"
        ;;
    
    rebuild)
        echo -e "${YELLOW}ðŸ”¨ Rebuilding WineLab Web...${NC}"
        
        # Stop service
        echo -e "${BLUE}  â†’ Stopping web service...${NC}"
        pm2 delete "$SERVICE_NAME" 2>/dev/null
        
        # Check if clean rebuild needed
        if [ "$2" == "--clean" ] || [ ! -d "node_modules" ]; then
            echo -e "${BLUE}  â†’ Cleaning old files...${NC}"
            rm -rf node_modules .next
            
            echo -e "${BLUE}  â†’ Installing dependencies...${NC}"
            npm install
        else
            # Always clean .next for rebuild
            echo -e "${BLUE}  â†’ Cleaning previous build...${NC}"
            rm -rf .next
        fi
        
        # Build
        echo -e "${BLUE}  â†’ Building production...${NC}"
        npm run build
        
        if [ $? -ne 0 ]; then
            echo -e "${RED}âŒ Build failed! Check errors above.${NC}"
            exit 1
        fi
        
        # Start web
        echo -e "${BLUE}  â†’ Starting web server...${NC}"
        pm2 start npm --name "$SERVICE_NAME" -- run start
        
        # Also restart API to ensure consistency
        echo -e "${BLUE}  â†’ Restarting API...${NC}"
        pm2 restart winelab-api 2>/dev/null || echo -e "${YELLOW}âš  API not running, skipped${NC}"
        
        pm2 save
        
        echo -e "${GREEN}âœ… Web rebuilt and started on http://localhost:8888${NC}"
        ;;
    
    update)
        echo -e "${BLUE}ðŸ”„ Updating WineLab Web from GitHub...${NC}"
        
        # Save package.json hashes before pull
        OLD_WEB_HASH=$(md5sum package.json 2>/dev/null | cut -d' ' -f1)
        OLD_API_HASH=$(md5sum winelab_api/package.json 2>/dev/null | cut -d' ' -f1)
        
        echo -e "${BLUE}  â†’ Pulling latest changes...${NC}"
        git reset --hard
        git pull
        
        # Check if web package.json changed or node_modules missing
        NEW_WEB_HASH=$(md5sum package.json 2>/dev/null | cut -d' ' -f1)
        if [ "$OLD_WEB_HASH" != "$NEW_WEB_HASH" ] || [ ! -d "node_modules" ]; then
            echo -e "${YELLOW}  â†’ Web dependencies changed or missing, installing...${NC}"
            npm install
        fi
        
        # Check if API package.json changed or node_modules missing
        NEW_API_HASH=$(md5sum winelab_api/package.json 2>/dev/null | cut -d' ' -f1)
        if [ "$OLD_API_HASH" != "$NEW_API_HASH" ] || [ ! -d "winelab_api/node_modules" ]; then
            echo -e "${YELLOW}  â†’ API dependencies changed or missing, installing...${NC}"
            cd winelab_api && npm install && cd ..
        fi
        
        # Update API (generates Prisma, runs migrations)
        echo -e "${BLUE}  â†’ Updating API...${NC}"
        cd winelab_api
        
        # Export for prisma if file exists
        if [ -f ".env" ]; then
            export $(grep -v '^#' .env | xargs)
        fi
        
        chmod +x install.sh 2>/dev/null || true
        
        npx prisma@5.22.0 generate
        npx prisma@5.22.0 migrate deploy
        cd ..
        
        # Rebuild web
        echo -e "${BLUE}  â†’ Setting permissions for Next.js...${NC}"
        chmod +x node_modules/.bin/next 2>/dev/null || true
        
        echo -e "${BLUE}  â†’ Rebuilding web...${NC}"
        # If build failed before, let's try a cleaner install
        rm -rf .next
        npm run build
        
        if [ $? -ne 0 ]; then
            echo -e "${YELLOW}  â†’ Build failed, trying with clean node_modules...${NC}"
            rm -rf node_modules package-lock.json
            npm install
            npm run build
        fi
        
        if [ $? -ne 0 ]; then
            echo -e "${RED}âŒ Build failed again! Check errors above.${NC}"
            exit 1
        fi
        
        # Restart services (Start if not existing)
        echo -e "${BLUE}  â†’ Starting/Restarting services...${NC}"
        pm2 restart "$SERVICE_NAME" 2>/dev/null || pm2 start npm --name "$SERVICE_NAME" -- run start
        pm2 restart winelab-api 2>/dev/null || pm2 start npm --name "winelab-api" --cwd "$(pwd)/winelab_api" -- run start:dev
        
        echo -e "${GREEN}âœ… WineLab updated successfully!${NC}"
        echo -e "${BLUE}   Web: http://YOUR_SERVER_IP:8888${NC}"
        echo -e "${BLUE}   API: http://YOUR_SERVER_IP:3001${NC}"
        ;;
    
    dev)
        echo -e "${BLUE}ðŸ”§ Starting in development mode...${NC}"
        pm2 stop "$SERVICE_NAME" 2>/dev/null
        npm run dev
        ;;
    
    logs)
        pm2 logs "$SERVICE_NAME" --lines 100
        ;;
    
    status)
        echo -e "${BLUE}ðŸ“Š WineLab Web Status${NC}"
        echo ""
        echo -e "${YELLOW}PM2:${NC}"
        pm2 status "$SERVICE_NAME"
        echo ""
        echo -e "${YELLOW}Build:${NC}"
        if [ -d ".next" ]; then
            echo "  .next exists: $(du -sh .next | cut -f1)"
        else
            echo "  .next: NOT BUILT"
        fi
        ;;
    
    *)
        echo -e "${BLUE}WineLab Web Management${NC}"
        echo ""
        echo "Usage: wlweb [command]"
        echo ""
        echo "Commands:"
        echo "  start       Start web server (production)"
        echo "  stop        Stop web server"
        echo "  restart     Restart web server"
        echo "  rebuild     Rebuild and restart (use --clean for full cleanup)"
        echo "  update      Git pull, rebuild, and restart"
        echo "  dev         Start in development mode"
        echo "  logs        Show web logs"
        echo "  status      Show service status"
        echo ""
        echo "Note: rebuild also restarts API for consistency"
        ;;
esac
