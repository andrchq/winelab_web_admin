generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============== ENUMS ==============

enum Role {
  ADMIN
  MANAGER
  WAREHOUSE
  SUPPORT
}

enum AssetCondition {
  WORKING
  NEEDS_REPAIR
  IN_REPAIR
  BROKEN
  DECOMMISSIONED
}

enum AssetProcess {
  AVAILABLE
  RESERVED
  IN_TRANSIT
  DELIVERED
  INSTALLED
}

enum RequestStatus {
  NEW
  IN_PROGRESS
  READY
  SHIPPED
  COMPLETED
  CANCELLED
}

enum RequestPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ShipmentStatus {
  DRAFT
  PICKING
  READY
  SHIPPED
  DELIVERED
}

enum DeliveryStatus {
  CREATED
  COURIER_ASSIGNED
  PICKED_UP
  IN_TRANSIT
  DELIVERED
  PROBLEM
  CANCELLED
}

enum StoreStatus {
  OPEN              // Открыт
  CLOSED            // Закрыт
  RECONSTRUCTION    // Реконструкция
  TECHNICAL_ISSUES  // Технические проблемы
}

// ============== MODELS ==============

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  phone     String?
  role      Role     @default(SUPPORT)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  requests         Request[]    @relation("RequestCreator")
  assignedRequests Request[]    @relation("RequestAssignee")
  shipments        Shipment[]
  comments         Comment[]
  auditLogs        AuditLog[]
  createdStores    Store[]      @relation("StoreCreator")
  receivingSessions ReceivingSession[] @relation("ReceivingCreator")

  @@map("users")
}

model Product {
  id          String   @id @default(uuid())
  name        String
  sku         String   @unique
  category    String
  description String?
  imageUrl    String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  assets        Asset[]
  stockItems    StockItem[]
  receivingItems ReceivingItem[]

  @@map("products")
}

model Asset {
  id            String         @id @default(uuid())
  serialNumber  String         @unique
  productId     String
  condition     AssetCondition @default(WORKING)
  processStatus AssetProcess   @default(AVAILABLE)
  purchaseDate  DateTime?
  warrantyUntil DateTime?
  notes         String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  // Location
  warehouseId   String?
  warehouseBinId String?
  storeId       String?

  // Relations
  product      Product       @relation(fields: [productId], references: [id])
  warehouse    Warehouse?    @relation(fields: [warehouseId], references: [id])
  warehouseBin WarehouseBin? @relation(fields: [warehouseBinId], references: [id])
  store        Store?        @relation(fields: [storeId], references: [id])
  
  requestItems RequestItem[]
  shipmentItems ShipmentItem[]
  assetHistory AssetHistory[]

  @@map("assets")
}

model StockItem {
  id          String   @id @default(uuid())
  productId   String
  warehouseId String
  quantity    Int      @default(0)
  reserved    Int      @default(0)
  minQuantity Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  product   Product   @relation(fields: [productId], references: [id])
  warehouse Warehouse @relation(fields: [warehouseId], references: [id])

  @@unique([productId, warehouseId])
  @@map("stock_items")
}

enum ReceivingStatus {
  DRAFT
  IN_PROGRESS
  COMPLETED
}

model ReceivingSession {
  id            String          @id @default(uuid())
  warehouseId   String
  status        ReceivingStatus @default(DRAFT)
  invoiceNumber String?
  supplier      String?
  createdById   String
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  completedAt   DateTime?

  // Relations
  warehouse Warehouse         @relation(fields: [warehouseId], references: [id])
  createdBy User              @relation("ReceivingCreator", fields: [createdById], references: [id])
  items     ReceivingItem[]

  @@map("receiving_sessions")
}

model ReceivingItem {
  id               String   @id @default(uuid())
  sessionId        String
  name             String
  sku              String?
  expectedQuantity Int      @default(0)
  scannedQuantity  Int      @default(0)
  productId        String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  session ReceivingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  product Product?         @relation(fields: [productId], references: [id])

  @@map("receiving_items")
}

model Warehouse {
  id        String   @id @default(uuid())
  name      String
  address   String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  // Relations
  bins              WarehouseBin[]
  assets            Asset[]
  stockItems        StockItem[]
  shipments         Shipment[]
  receivingSessions ReceivingSession[]

  @@map("warehouses")
}

model WarehouseBin {
  id          String   @id @default(uuid())
  warehouseId String
  code        String
  description String?

  // Relations
  warehouse Warehouse @relation(fields: [warehouseId], references: [id])
  assets    Asset[]

  @@unique([warehouseId, code])
  @@map("warehouse_bins")
}

model Store {
  id        String   @id @default(uuid())
  name      String
  address   String
  city      String?  // Город
  cfo       String?  // ЦФО
  
  // Technical Info
  serverIp    String? // ip Сервера
  providerIp1 String? // ip provider 1
  providerIp2 String? // ip provider 2
  utmUrl      String? // УТМ ссылка
  retailUrl   String? // Retail ссылка
  
  // Legal Info
  legalEntity String? // Юр.лицо
  inn         String? // ИНН
  kpp         String? // КПП
  fsrarId     String? // ФСРАР
  
  // CCTV
  cctvSystem  String? // СВН
  cameraCount Int?    // Кол-во камер

  region    String?
  phone     String?
  email     String?
  manager   String?
  status    StoreStatus @default(OPEN)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  createdById String?
  creator     User?    @relation("StoreCreator", fields: [createdById], references: [id])

  // Relations
  assets    Asset[]
  requests  Request[]
  deliveries Delivery[]

  @@map("stores")
}

model Request {
  id          String          @id @default(uuid())
  title       String
  description String?
  priority    RequestPriority @default(MEDIUM)
  status      RequestStatus   @default(NEW)
  storeId     String
  creatorId   String
  assigneeId  String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  // Relations
  store     Store         @relation(fields: [storeId], references: [id])
  creator   User          @relation("RequestCreator", fields: [creatorId], references: [id])
  assignee  User?         @relation("RequestAssignee", fields: [assigneeId], references: [id])
  items     RequestItem[]
  shipments Shipment[]
  comments  Comment[]

  @@map("requests")
}

model RequestItem {
  id        String @id @default(uuid())
  requestId String
  assetId   String
  notes     String?

  // Relations
  request Request @relation(fields: [requestId], references: [id], onDelete: Cascade)
  asset   Asset   @relation(fields: [assetId], references: [id])

  @@map("request_items")
}

model Shipment {
  id          String         @id @default(uuid())
  requestId   String
  warehouseId String
  status      ShipmentStatus @default(DRAFT)
  assembledBy String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  // Relations
  request   Request        @relation(fields: [requestId], references: [id])
  warehouse Warehouse      @relation(fields: [warehouseId], references: [id])
  assembler User?          @relation(fields: [assembledBy], references: [id])
  items     ShipmentItem[]
  delivery  Delivery?

  @@map("shipments")
}

model ShipmentItem {
  id         String   @id @default(uuid())
  shipmentId String
  assetId    String
  picked     Boolean  @default(false)
  pickedAt   DateTime?

  // Relations
  shipment Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  asset    Asset    @relation(fields: [assetId], references: [id])

  @@map("shipment_items")
}

model Delivery {
  id          String         @id @default(uuid())
  shipmentId  String         @unique
  storeId     String
  provider    String
  externalId  String?
  status      DeliveryStatus @default(CREATED)
  courierName String?
  courierPhone String?
  eta         DateTime?
  deliveredAt DateTime?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  // Relations
  shipment Shipment        @relation(fields: [shipmentId], references: [id])
  store    Store           @relation(fields: [storeId], references: [id])
  events   DeliveryEvent[]

  @@map("deliveries")
}

model DeliveryEvent {
  id         String   @id @default(uuid())
  deliveryId String
  title      String
  description String?
  timestamp  DateTime @default(now())

  // Relations
  delivery Delivery @relation(fields: [deliveryId], references: [id], onDelete: Cascade)

  @@map("delivery_events")
}

model Comment {
  id        String   @id @default(uuid())
  requestId String
  userId    String
  text      String
  createdAt DateTime @default(now())

  // Relations
  request Request @relation(fields: [requestId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id])

  @@map("comments")
}

model AssetHistory {
  id        String   @id @default(uuid())
  assetId   String
  action    String
  location  String?
  userId    String?
  createdAt DateTime @default(now())

  // Relations
  asset Asset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@map("asset_history")
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String
  action    String
  entity    String
  entityId  String
  changes   Json?
  ipAddress String?
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@map("audit_logs")
}
